
#= none:1 =#
struct TKEDissipationVerticalDiffusivity{TD, KE, ST, LMIN, FT, DT} <: AbstractScalarDiffusivity{TD, VerticalFormulation, 2}
    #= none:2 =#
    tke_dissipation_equations::KE
    #= none:3 =#
    stability_functions::ST
    #= none:4 =#
    minimum_length_scale::LMIN
    #= none:5 =#
    maximum_tracer_diffusivity::FT
    #= none:6 =#
    maximum_tke_diffusivity::FT
    #= none:7 =#
    maximum_dissipation_diffusivity::FT
    #= none:8 =#
    maximum_viscosity::FT
    #= none:9 =#
    minimum_tke::FT
    #= none:10 =#
    minimum_stratification_number_safety_factor::FT
    #= none:11 =#
    negative_tke_damping_time_scale::FT
    #= none:12 =#
    tke_dissipation_time_step::DT
end
#= none:15 =#
function TKEDissipationVerticalDiffusivity{TD}(tke_dissipation_equations::KE, stability_functions::ST, minimum_length_scale::LMIN, maximum_tracer_diffusivity::FT, maximum_tke_diffusivity::FT, maximum_dissipation_diffusivity::FT, maximum_viscosity::FT, minimum_tke::FT, minimum_stratification_number_safety_factor::FT, negative_tke_damping_time_scale::FT, tke_dissipation_time_step::DT) where {TD, KE, ST, LMIN, FT, DT}
    #= none:15 =#
    #= none:27 =#
    return TKEDissipationVerticalDiffusivity{TD, KE, ST, LMIN, FT, DT}(tke_dissipation_equations, stability_functions, minimum_length_scale, maximum_tracer_diffusivity, maximum_tke_diffusivity, maximum_dissipation_diffusivity, maximum_viscosity, minimum_tke, minimum_stratification_number_safety_factor, negative_tke_damping_time_scale, tke_dissipation_time_step)
end
#= none:40 =#
TKEDissipationVerticalDiffusivity(FT::DataType; kw...) = begin
        #= none:40 =#
        TKEDissipationVerticalDiffusivity(VerticallyImplicitTimeDiscretization(), FT; kw...)
    end
#= none:43 =#
const TDVD{TD} = (TKEDissipationVerticalDiffusivity{TD} where TD)
#= none:44 =#
const TDVDArray{TD} = (AbstractArray{<:TDVD{TD}} where TD)
#= none:45 =#
const FlavorOfTD{TD} = (Union{TDVD{TD}, TDVDArray{TD}} where TD)
#= none:47 =#
#= none:47 =# @inline (Base.eltype(::TKEDissipationVerticalDiffusivity{<:Any, <:Any, <:Any, <:Any, FT}) where FT) = begin
            #= none:47 =#
            FT
        end
#= none:49 =#
#= none:49 =# Core.@doc "    TKEDissipationVerticalDiffusivity([time_discretization = VerticallyImplicitTimeDiscretization(),\n                                      FT = Float64;]\n                                      tke_dissipation_equations = TKEDissipationEquations(),\n                                      stability_functions = VariableStabilityFunctions(),\n                                      minimum_length_scale = StratifiedDisplacementScale(),\n                                      maximum_tracer_diffusivity = Inf,\n                                      maximum_tke_diffusivity = Inf,\n                                      maximum_dissipation_diffusivity = Inf,\n                                      maximum_viscosity = Inf,\n                                      minimum_tke = 1e-6,\n                                      minimum_stratification_number_safety_factor = 0.73,\n                                      negative_tke_damping_time_scale = 1minute,\n                                      tke_dissipation_time_step = nothing)\n\nReturn the `TKEDissipationVerticalDiffusivity` turbulence closure for vertical mixing by\nmicroscale ocean turbulence based on the prognostic evolution of two variables: the \nturbulent kinetic energy (TKE), and the turbulent kinetic energy dissipation.\nElsewhere this is referred to as \"k-Ïµ\". For more information about k-Ïµ, see\nBurchard and Bolding (2001), Umlauf and Buchard (2003), and Umlauf and Burchard (2005).\n\nArguments\n=========\n\n- `time_discretization`: Either `ExplicitTimeDiscretization()` or `VerticallyImplicitTimeDiscretization()`;\n                         default `VerticallyImplicitTimeDiscretization()`.\n\n- `FT`: Float type; default `Float64`.\n\n\nKeyword arguments\n=================\n\n- `maximum_diffusivity`: Maximum value for tracer, momentum, and TKE diffusivities.\n                         Used to clip the diffusivity when/if\n                         TKEDissipationVerticalDiffusivity predicts diffusivities\n                         that are too large.\n                         Default: `Inf`.\n\n- `minimum_tke`: Minimum value for the turbulent kinetic energy.\n                 Can be used to model the presence \"background\" TKE\n                 levels due to, for example, mixing by breaking internal waves.\n                 Default: 1e-9.\n\n- `negative_tke_damping_time_scale`: Damping time-scale for spurious negative values of TKE,\n                                     typically generated by oscillatory errors associated\n                                     with TKE advection.\n                                     Default: 1 minute.\n\nNote that for numerical stability, it is recommended to either have a relative short\n`negative_turbulent_kinetic_energy_damping_time_scale` or a reasonable\n`minimum_turbulent_kinetic_energy`, or both.\n" function TKEDissipationVerticalDiffusivity(time_discretization::TD = VerticallyImplicitTimeDiscretization(), FT = Float64; tke_dissipation_equations = TKEDissipationEquations(), stability_functions = VariableStabilityFunctions(), minimum_length_scale = StratifiedDisplacementScale(), maximum_tracer_diffusivity = Inf, maximum_tke_diffusivity = Inf, maximum_dissipation_diffusivity = Inf, maximum_viscosity = Inf, minimum_tke = 1.0e-6, minimum_stratification_number_safety_factor = 0.73, negative_tke_damping_time_scale = 1minute, tke_dissipation_time_step = nothing) where TD
        #= none:102 =#
        #= none:116 =#
        stability_functions = convert_eltype(FT, stability_functions)
        #= none:118 =#
        return TKEDissipationVerticalDiffusivity{TD}(tke_dissipation_equations, stability_functions, minimum_length_scale, convert(FT, maximum_tracer_diffusivity), convert(FT, maximum_tke_diffusivity), convert(FT, maximum_dissipation_diffusivity), convert(FT, maximum_viscosity), convert(FT, minimum_tke), convert(FT, minimum_stratification_number_safety_factor), convert(FT, negative_tke_damping_time_scale), tke_dissipation_time_step)
    end
#= none:131 =#
function with_tracers(tracer_names, closure::FlavorOfTD)
    #= none:131 =#
    #= none:132 =#
    :e âˆˆ tracer_names && :Ïµ âˆˆ tracer_names || throw(ArgumentError("Tracers must contain :e and :Ïµ to represent turbulent kinetic energy " * "for `TKEDissipationVerticalDiffusivity`."))
    #= none:136 =#
    return closure
end
#= none:143 =#
#= none:143 =# Base.@kwdef struct StratifiedDisplacementScale{FT}
        #= none:144 =#
        Cá´º::FT = 0.75
        #= none:145 =#
        minimum_buoyancy_frequency::FT = 1.0e-14
    end
#= none:152 =#
function DiffusivityFields(grid, tracer_names, bcs, closure::FlavorOfTD)
    #= none:152 =#
    #= none:154 =#
    default_diffusivity_bcs = (Îºu = FieldBoundaryConditions(grid, (Center, Center, Face)), Îºc = FieldBoundaryConditions(grid, (Center, Center, Face)), Îºe = FieldBoundaryConditions(grid, (Center, Center, Face)), ÎºÏµ = FieldBoundaryConditions(grid, (Center, Center, Face)))
    #= none:159 =#
    bcs = merge(default_diffusivity_bcs, bcs)
    #= none:161 =#
    Îºu = ZFaceField(grid, boundary_conditions = bcs.Îºu)
    #= none:162 =#
    Îºc = ZFaceField(grid, boundary_conditions = bcs.Îºc)
    #= none:163 =#
    Îºe = ZFaceField(grid, boundary_conditions = bcs.Îºe)
    #= none:164 =#
    ÎºÏµ = ZFaceField(grid, boundary_conditions = bcs.ÎºÏµ)
    #= none:165 =#
    Le = CenterField(grid)
    #= none:166 =#
    LÏµ = CenterField(grid)
    #= none:170 =#
    uâ» = XFaceField(grid)
    #= none:171 =#
    vâ» = YFaceField(grid)
    #= none:172 =#
    previous_velocities = (; u = uâ», v = vâ»)
    #= none:175 =#
    _tupled_tracer_diffusivities = Dict{Symbol, Any}((name => Îºc for name = tracer_names))
    #= none:176 =#
    _tupled_tracer_diffusivities[:e] = Îºe
    #= none:177 =#
    _tupled_tracer_diffusivities[:Ïµ] = ÎºÏµ
    #= none:178 =#
    _tupled_tracer_diffusivities = NamedTuple((name => _tupled_tracer_diffusivities[name] for name = tracer_names))
    #= none:181 =#
    _tupled_implicit_linear_coefficients = Dict{Symbol, Any}((name => ZeroField() for name = tracer_names))
    #= none:182 =#
    _tupled_implicit_linear_coefficients[:e] = Le
    #= none:183 =#
    _tupled_implicit_linear_coefficients[:Ïµ] = LÏµ
    #= none:184 =#
    _tupled_implicit_linear_coefficients = NamedTuple((name => _tupled_implicit_linear_coefficients[name] for name = tracer_names))
    #= none:187 =#
    return (; Îºu, Îºc, Îºe, ÎºÏµ, Le, LÏµ, previous_velocities, _tupled_tracer_diffusivities, _tupled_implicit_linear_coefficients)
end
#= none:191 =#
#= none:191 =# @inline viscosity_location(::FlavorOfTD) = begin
            #= none:191 =#
            (c, c, f)
        end
#= none:192 =#
#= none:192 =# @inline diffusivity_location(::FlavorOfTD) = begin
            #= none:192 =#
            (c, c, f)
        end
#= none:194 =#
function compute_diffusivities!(diffusivities, closure::FlavorOfTD, model; parameters = :xyz)
    #= none:194 =#
    #= none:196 =#
    arch = model.architecture
    #= none:197 =#
    grid = model.grid
    #= none:198 =#
    velocities = model.velocities
    #= none:199 =#
    tracers = model.tracers
    #= none:200 =#
    buoyancy = model.buoyancy
    #= none:201 =#
    clock = model.clock
    #= none:202 =#
    top_tracer_bcs = NamedTuple((c => (tracers[c]).boundary_conditions.top for c = propertynames(tracers)))
    #= none:204 =#
    if isfinite(model.clock.last_Î”t)
        #= none:208 =#
        time_step_tke_dissipation_equations!(model)
    end
    #= none:212 =#
    (u, v, w) = model.velocities
    #= none:213 =#
    (uâ», vâ») = diffusivities.previous_velocities
    #= none:214 =#
    parent(uâ») .= parent(u)
    #= none:215 =#
    parent(vâ») .= parent(v)
    #= none:217 =#
    launch!(arch, grid, parameters, compute_TKEDissipation_diffusivities!, diffusivities, grid, closure, velocities, tracers, buoyancy)
    #= none:221 =#
    return nothing
end
#= none:224 =#
#= none:224 =# @kernel function compute_TKEDissipation_diffusivities!(diffusivities, grid, closure::FlavorOfTD, velocities, tracers, buoyancy)
        #= none:224 =#
        #= none:226 =#
        (i, j, k) = #= none:226 =# @index(Global, NTuple)
        #= none:229 =#
        closure_ij = getclosure(i, j, closure)
        #= none:233 =#
        Îºuâ˜… = Îºuá¶œá¶œá¶ (i, j, k, grid, closure_ij, velocities, tracers, buoyancy)
        #= none:234 =#
        Îºcâ˜… = Îºcá¶œá¶œá¶ (i, j, k, grid, closure_ij, velocities, tracers, buoyancy)
        #= none:235 =#
        Îºeâ˜… = Îºeá¶œá¶œá¶ (i, j, k, grid, closure_ij, velocities, tracers, buoyancy)
        #= none:236 =#
        ÎºÏµâ˜… = ÎºÏµá¶œá¶œá¶ (i, j, k, grid, closure_ij, velocities, tracers, buoyancy)
        #= none:238 =#
        Îºuâ˜… = mask_diffusivity(i, j, k, grid, Îºuâ˜…)
        #= none:239 =#
        Îºcâ˜… = mask_diffusivity(i, j, k, grid, Îºcâ˜…)
        #= none:240 =#
        Îºeâ˜… = mask_diffusivity(i, j, k, grid, Îºeâ˜…)
        #= none:241 =#
        ÎºÏµâ˜… = mask_diffusivity(i, j, k, grid, ÎºÏµâ˜…)
        #= none:243 =#
        #= none:243 =# @inbounds begin
                #= none:244 =#
                diffusivities.Îºu[i, j, k] = Îºuâ˜…
                #= none:245 =#
                diffusivities.Îºc[i, j, k] = Îºcâ˜…
                #= none:246 =#
                diffusivities.Îºe[i, j, k] = Îºeâ˜…
                #= none:247 =#
                diffusivities.ÎºÏµ[i, j, k] = ÎºÏµâ˜…
            end
    end
#= none:251 =#
#= none:251 =# @inline function turbulent_kinetic_energyá¶œá¶œá¶œ(i, j, k, grid, closure, tracers)
        #= none:251 =#
        #= none:252 =#
        eáµâ±â¿ = closure.minimum_tke
        #= none:253 =#
        eâ±Ê²áµ = #= none:253 =# @inbounds(tracers.e[i, j, k])
        #= none:254 =#
        return max(eáµâ±â¿, eâ±Ê²áµ)
    end
#= none:257 =#
#= none:257 =# @inline max_a_b(i, j, k, grid, a::Number, b, args...) = begin
            #= none:257 =#
            max(a, b(i, j, k, grid, args...))
        end
#= none:259 =#
#= none:259 =# @inline maximum_dissipation(i, j, k, grid, closure, tracers, buoyancy) = begin
            #= none:259 =#
            convert(eltype(grid), Inf)
        end
#= none:261 =#
#= none:261 =# @inline function minimum_dissipation(i, j, k, grid, closure, tracers, buoyancy)
        #= none:261 =#
        #= none:262 =#
        FT = eltype(grid)
        #= none:264 =#
        NÂ²min = closure.minimum_length_scale.minimum_buoyancy_frequency
        #= none:265 =#
        NÂ²âº = â„‘bzáµƒáµƒá¶œ(i, j, k, grid, max_a_b, NÂ²min, âˆ‚z_b, buoyancy, tracers)
        #= none:267 =#
        Cá´º = closure.minimum_length_scale.Cá´º
        #= none:268 =#
        eâ˜… = turbulent_kinetic_energyá¶œá¶œá¶œ(i, j, k, grid, closure, tracers)
        #= none:269 =#
        â„“st = Cá´º * sqrt(eâ˜… / NÂ²âº)
        #= none:271 =#
        ğ•Šuâ‚€ = closure.stability_functions.ğ•Šuâ‚€
        #= none:272 =#
        â„“min = min(grid.Lz, â„“st)
        #= none:273 =#
        Ïµmin = (ğ•Šuâ‚€ ^ 3 * sqrt(eâ˜…) ^ 3) / â„“min
        #= none:275 =#
        another_Ïµmin = convert(FT, 1.0e-12)
        #= none:276 =#
        return max(another_Ïµmin, Ïµmin)
    end
#= none:279 =#
#= none:279 =# @inline function dissipationá¶œá¶œá¶œ(i, j, k, grid, closure, tracers, buoyancy)
        #= none:279 =#
        #= none:280 =#
        Ïµáµâ±â¿ = minimum_dissipation(i, j, k, grid, closure, tracers, buoyancy)
        #= none:281 =#
        ÏµáµáµƒË£ = maximum_dissipation(i, j, k, grid, closure, tracers, buoyancy)
        #= none:282 =#
        Ïµâ±Ê²áµ = #= none:282 =# @inbounds(tracers.Ïµ[i, j, k])
        #= none:283 =#
        return clamp(Ïµâ±Ê²áµ, Ïµáµâ±â¿, ÏµáµáµƒË£)
    end
#= none:286 =#
#= none:286 =# @inline function Îºuá¶œá¶œá¶ (i, j, k, grid, closure::TDVD, velocities, tracers, buoyancy)
        #= none:286 =#
        #= none:287 =#
        eÂ² = â„‘záµƒáµƒá¶ (i, j, k, grid, Ï•Â², turbulent_kinetic_energyá¶œá¶œá¶œ, closure, tracers)
        #= none:288 =#
        Ïµ = â„‘záµƒáµƒá¶ (i, j, k, grid, dissipationá¶œá¶œá¶œ, closure, tracers, buoyancy)
        #= none:289 =#
        ğ•Šu = momentum_stability_functioná¶œá¶œá¶ (i, j, k, grid, closure, velocities, tracers, buoyancy)
        #= none:290 =#
        Îºu = (ğ•Šu * eÂ²) / Ïµ
        #= none:291 =#
        Îºu_max = closure.maximum_viscosity
        #= none:292 =#
        return min(Îºu, Îºu_max)
    end
#= none:295 =#
#= none:295 =# @inline function Îºcá¶œá¶œá¶ (i, j, k, grid, closure::TDVD, velocities, tracers, buoyancy)
        #= none:295 =#
        #= none:296 =#
        eÂ² = â„‘záµƒáµƒá¶ (i, j, k, grid, Ï•Â², turbulent_kinetic_energyá¶œá¶œá¶œ, closure, tracers)
        #= none:297 =#
        Ïµ = â„‘záµƒáµƒá¶ (i, j, k, grid, dissipationá¶œá¶œá¶œ, closure, tracers, buoyancy)
        #= none:298 =#
        ğ•Šc = tracer_stability_functioná¶œá¶œá¶ (i, j, k, grid, closure, velocities, tracers, buoyancy)
        #= none:299 =#
        Îºc = (ğ•Šc * eÂ²) / Ïµ
        #= none:300 =#
        Îºc_max = closure.maximum_tracer_diffusivity
        #= none:301 =#
        return min(Îºc, Îºc_max)
    end
#= none:304 =#
#= none:304 =# @inline function Îºeá¶œá¶œá¶ (i, j, k, grid, closure::TDVD, velocities, tracers, buoyancy)
        #= none:304 =#
        #= none:305 =#
        eÂ² = â„‘záµƒáµƒá¶ (i, j, k, grid, Ï•Â², turbulent_kinetic_energyá¶œá¶œá¶œ, closure, tracers)
        #= none:306 =#
        Ïµ = â„‘záµƒáµƒá¶ (i, j, k, grid, dissipationá¶œá¶œá¶œ, closure, tracers, buoyancy)
        #= none:307 =#
        ğ•Še = tke_stability_functioná¶œá¶œá¶ (i, j, k, grid, closure, velocities, tracers, buoyancy)
        #= none:308 =#
        Îºe = (ğ•Še * eÂ²) / Ïµ
        #= none:309 =#
        Îºe_max = closure.maximum_tke_diffusivity
        #= none:310 =#
        return min(Îºe, Îºe_max)
    end
#= none:313 =#
#= none:313 =# @inline function ÎºÏµá¶œá¶œá¶ (i, j, k, grid, closure::TDVD, velocities, tracers, buoyancy)
        #= none:313 =#
        #= none:314 =#
        eÂ² = â„‘záµƒáµƒá¶ (i, j, k, grid, Ï•Â², turbulent_kinetic_energyá¶œá¶œá¶œ, closure, tracers)
        #= none:315 =#
        Ïµ = â„‘záµƒáµƒá¶ (i, j, k, grid, dissipationá¶œá¶œá¶œ, closure, tracers, buoyancy)
        #= none:316 =#
        ğ•ŠÏµ = dissipation_stability_functioná¶œá¶œá¶ (i, j, k, grid, closure, velocities, tracers, buoyancy)
        #= none:317 =#
        ÎºÏµ = (ğ•ŠÏµ * eÂ²) / Ïµ
        #= none:318 =#
        ÎºÏµ_max = closure.maximum_dissipation_diffusivity
        #= none:319 =#
        return min(ÎºÏµ, ÎºÏµ_max)
    end
#= none:322 =#
#= none:322 =# @inline viscosity(::FlavorOfTD, diffusivities) = begin
            #= none:322 =#
            diffusivities.Îºu
        end
#= none:323 =#
#= none:323 =# @inline (diffusivity(::FlavorOfTD, diffusivities, ::Val{id}) where id) = begin
            #= none:323 =#
            diffusivities._tupled_tracer_diffusivities[id]
        end
#= none:329 =#
function Base.summary(closure::TDVD)
    #= none:329 =#
    #= none:330 =#
    TD = nameof(typeof(time_discretization(closure)))
    #= none:331 =#
    return string("TKEDissipationVerticalDiffusivity{$(TD)}")
end
#= none:334 =#
function Base.show(io::IO, clo::TDVD)
    #= none:334 =#
    #= none:335 =#
    print(io, summary(clo))
    #= none:336 =#
    print(io, '\n')
    #= none:337 =#
    print(io, "â”œâ”€â”€ maximum_tracer_diffusivity: ", prettysummary(clo.maximum_tracer_diffusivity), '\n', "â”œâ”€â”€ maximum_tke_diffusivity: ", prettysummary(clo.maximum_tke_diffusivity), '\n', "â”œâ”€â”€ maximum_dissipation_diffusivity: ", prettysummary(clo.maximum_dissipation_diffusivity), '\n', "â”œâ”€â”€ maximum_viscosity: ", prettysummary(clo.maximum_viscosity), '\n', "â”œâ”€â”€ minimum_tke: ", prettysummary(clo.minimum_tke), '\n', "â”œâ”€â”€ negative_tke_damping_time_scale: ", prettysummary(clo.negative_tke_damping_time_scale), '\n', "â”œâ”€â”€ tke_dissipation_time_step: ", prettysummary(clo.tke_dissipation_time_step), '\n', "â”œâ”€â”€ tke_dissipation_equations: ", prettysummary(clo.tke_dissipation_equations), '\n', "â”‚   â”œâ”€â”€ Cáµ‹Ïµ: ", prettysummary(clo.tke_dissipation_equations.Cáµ‹Ïµ), '\n', "â”‚   â”œâ”€â”€ Cá´¾Ïµ: ", prettysummary(clo.tke_dissipation_equations.Cá´¾Ïµ), '\n', "â”‚   â”œâ”€â”€ Cáµ‡Ïµ: ", prettysummary(clo.tke_dissipation_equations.Cáµ‡Ïµ), '\n', "â”‚   â”œâ”€â”€ Cáµ‚uâ˜…: ", prettysummary(clo.tke_dissipation_equations.Cáµ‚uâ˜…), '\n', "â”‚   â””â”€â”€ Cáµ‚wÎ”: ", prettysummary(clo.tke_dissipation_equations.Cáµ‚wÎ”), '\n')
    #= none:350 =#
    print(io, "â””â”€â”€ ", summarize_stability_functions(clo.stability_functions), "", "    ")
end